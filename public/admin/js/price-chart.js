'use strict';
// Product price history chart & interactions (extracted)
(function(){
  function parse(){ var t=document.getElementById('price-chart-data'); if(!t) return {}; try { return JSON.parse(t.innerHTML.trim()||'{}'); } catch(e){ return {}; } }
  function init(){ var d=parse(); if(!d.labels) return; if(window.Chart){ build(d); } else { wait(function(){ build(d); }); } }
  function wait(cb){ var i=0; (function loop(){ if(window.Chart){ cb(); return; } if(i++>40) return; setTimeout(loop,120); })(); }
  function build(d){ var ctx=document.getElementById('priceChart'); if(!ctx) return; var chart=new Chart(ctx.getContext('2d'), { type:'line', data:{ labels:d.labels, datasets:[ { label:d.i18n.priceLabel, data:d.dataNew, borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,.08)', yAxisID:'y', tension:.25, pointRadius:3 }, { label:'SMA ('+d.window+')', data:d.sma, borderColor:'#6f42c1', borderDash:[5,5], yAxisID:'y', tension:.25, pointRadius:0, hidden:!d.showSma }, { label:'EMA ('+d.window+')', data:d.ema, borderColor:'#fd7e14', borderDash:[4,4], yAxisID:'y', tension:.25, pointRadius:0, hidden:!d.showEma }, { label:'% '+d.i18n.changeLabel, data:d.percent, borderColor:'#dc3545', backgroundColor:'rgba(220,53,69,.15)', yAxisID:'y1', tension:.25, hidden:true, pointRadius:3 }, { label:d.i18n.interestLabel, data:d.interestCounts, borderColor:'#198754', backgroundColor:'rgba(25,135,84,.15)', yAxisID:'y2', hidden:true, tension:.25, pointRadius:3 } ] }, options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, stacked:false, plugins:{ tooltip:{ callbacks:{ label:function(ctx){ if(ctx.dataset.label.indexOf('%')>-1) return ctx.dataset.label+': '+ctx.parsed.y.toFixed(2)+'%'; if(ctx.dataset.label.startsWith('SMA')||ctx.dataset.label.startsWith('EMA')) return ctx.dataset.label+': '+ctx.parsed.y; var smaIdx=chart.data.datasets.findIndex(d=>d.label.startsWith('SMA')); var emaIdx=chart.data.datasets.findIndex(d=>d.label.startsWith('EMA')); var diffStr=''; if(smaIdx>-1 && !chart.data.datasets[smaIdx].hidden){ var smaVal=chart.data.datasets[smaIdx].data[ctx.dataIndex]; if(smaVal!==undefined){ var diff=ctx.parsed.y - smaVal; diffStr+=' (ΔS '+diff.toFixed(2)+')'; } } if(emaIdx>-1 && !chart.data.datasets[emaIdx].hidden){ var emaVal=chart.data.datasets[emaIdx].data[ctx.dataIndex]; if(emaVal!==undefined){ var diff2=ctx.parsed.y - emaVal; diffStr+=' (ΔE '+diff2.toFixed(2)+')'; } } return ctx.dataset.label+': '+ctx.parsed.y+diffStr; } } }, legend:{ labels:{ usePointStyle:true } } }, scales:{ y:{ type:'linear', position:'left', title:{display:true,text:d.i18n.priceLabel}, grid:{display:true} }, y1:{ type:'linear', position:'right', title:{display:true,text:'% '+d.i18n.changeLabel}, grid:{display:false}, ticks:{ callback:v=>v+'%' } }, y2:{ type:'linear', position:'right', title:{display:true,text:d.i18n.interestsLabel}, grid:{display:false}, offset:true } } } });
    function colorDrops(){ var percentDs=chart.data.datasets[3]; var priceDs=chart.data.datasets[0]; if(!percentDs) return; priceDs.pointBackgroundColor = priceDs.data.map(function(_,i){ var p=percentDs.data[i]; if(p!==undefined && p <= -Math.abs(d.threshold)){ return '#dc3545'; } return '#0d6efd'; }); }
    colorDrops();
    var btnPercent=document.getElementById('btnTogglePercent'); if(btnPercent) btnPercent.addEventListener('click', function(){ var ds=chart.data.datasets[3]; ds.hidden=!ds.hidden; chart.update(); });
    var btnInterest=document.getElementById('btnToggleInterest'); if(btnInterest) btnInterest.addEventListener('click', function(){ var ds=chart.data.datasets[4]; ds.hidden=!ds.hidden; chart.update(); });
    var btnCsv=document.getElementById('btnExportCsv'); if(btnCsv) btnCsv.addEventListener('click', function(){ var rows=[['Date','Old','New','Percent']]; (d.raw||[]).forEach(function(r){ rows.push([r.date,r.old,r.new,r.percent]); }); var csv=rows.map(r=>r.join(',')).join('\n'); var blob=new Blob([csv],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='price-history-'+d.productId+'.csv'; a.click(); });
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
